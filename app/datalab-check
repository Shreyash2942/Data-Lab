#!/usr/bin/env bash
# Quick health-check for the Data Lab container.
set -euo pipefail

if [ -z "${BASH_VERSION:-}" ]; then
  echo "This script must be run with bash (try: bash datalab-check)." >&2
  exit 1
fi

APP_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
APP_REPO_ROOT="$(cd "${APP_DIR}/.." && pwd)"
SERVICE_NAME="${SERVICE_NAME:-data-lab}"
CONTAINER_NAME="${CONTAINER_NAME:-datalab}"
SCRIPT_NAME="$(basename "${BASH_SOURCE[0]}")"
source "${APP_DIR}/scripts/host_exec.sh"

datalab::ensure_inside_or_exec "${APP_REPO_ROOT}" "${SERVICE_NAME}" "${CONTAINER_NAME}" "/home/datalab/app/${SCRIPT_NAME}" "$@"

source "${APP_DIR}/scripts/common.sh"

# Guard in case strip_cr was not loaded for any reason.
if ! declare -F strip_cr >/dev/null; then
  strip_cr() {
    local value="${1:-}"
    value="${value//$'\r'/}"
    printf '%s' "${value}"
  }
fi

WORKSPACE="$(strip_cr "${WORKSPACE:-/home/datalab}")"
RUNTIME_ROOT="$(strip_cr "${RUNTIME_ROOT:-${WORKSPACE}/runtime}")"
mkdir -p "${RUNTIME_ROOT}"

ok()  { printf '[OK]   %s\n' "$*"; }
fail(){ printf '[FAIL] %s\n' "$*"; }

errors=()

run_check() {
  local label="$1"
  shift
  if "$@">/tmp/datalab-check.out 2>&1; then
    ok "${label}"
  else
    fail "${label}"
    errors+=("${label}")
    printf '  -> '; tail -n 2 /tmp/datalab-check.out 2>/dev/null || true
  fi
}

echo "=== Data Lab :: Quick Check ==="
echo "Workspace: ${WORKSPACE}"

run_check "Python" python --version
run_check "Airflow CLI" airflow version
run_check "Spark CLI" spark-submit --version
run_check "Hadoop CLI" hadoop version
run_check "Hive CLI" hive --version
run_check "Kafka CLI" "${KAFKA_HOME}/bin/kafka-topics.sh" --version
run_check "dbt" dbt --version
run_check "Terraform" terraform version
run_check "Hudi jar" test -f "${SPARK_HOME}/jars/hudi-spark-bundle.jar"
run_check "Iceberg jar" test -f "${SPARK_HOME}/jars/iceberg-spark-runtime.jar"
run_check "Delta jar" test -f "${SPARK_HOME}/jars/delta-spark.jar"

echo
if [ "${#errors[@]}" -eq 0 ]; then
  echo "[+] All quick checks passed."
else
  echo "[!] ${#errors[@]} check(s) failed. See output above."
fi
