#!/usr/bin/env bash
set -e

APP_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
APP_REPO_ROOT="$(cd "${APP_DIR}/.." && pwd)"
SERVICE_NAME="${SERVICE_NAME:-data-lab}"
SCRIPT_NAME="$(basename "${BASH_SOURCE[0]}")"

if [ ! -f "/.dockerenv" ] && [ -z "${INSIDE_DATALAB:-}" ]; then
  if ! command -v docker >/dev/null 2>&1; then
    echo "Please run inside the data-lab container (docker compose exec data-lab bash)." >&2
    exit 1
  fi
  (
    cd "${APP_REPO_ROOT}"
    docker compose exec -e INSIDE_DATALAB=1 "${SERVICE_NAME}" "/home/datalab/app/${SCRIPT_NAME}" "$@"
  )
  exit $?
fi

source "${APP_DIR}/scripts/common.sh"
source "${APP_DIR}/scripts/hadoop/manage.sh"
source "${APP_DIR}/scripts/hive/manage.sh"
source "${APP_DIR}/scripts/kafka/manage.sh"
source "${APP_DIR}/scripts/spark/manage.sh"
source "${APP_DIR}/scripts/services_utils.sh"

handle_cli_flag() {
  case "$1" in
    --stop-spark) spark::stop; exit 0 ;;
    --stop-hadoop) hadoop::stop; exit 0 ;;
    --stop-hive) hive::stop; exit 0 ;;
    --stop-kafka) kafka::stop; exit 0 ;;
    --stop-airflow) services::stop_airflow; exit 0 ;;
    --stop-core)
      kafka::stop || true
      hive::stop || true
      hadoop::stop || true
      spark::stop || true
      echo "[+] Spark/Hadoop/Hive/Kafka services stopped."
      exit 0
      ;;
  esac
}

handle_cli_flag "${1:-}" || true

echo "=== Data Lab :: STOP MENU ==="
echo "1) Stop Spark services"
echo "2) Stop Hadoop services"
echo "3) Stop Hive services"
echo "4) Stop Kafka services"
echo "5) Stop Airflow webserver & scheduler"
echo "6) Stop ALL core services (Spark/Hadoop/Hive/Kafka)"
echo "7) Stop Docker container"
echo "0) Exit"
read -p "Select option: " opt

case "$opt" in
  1)
    spark::stop
    echo "[+] Spark services stopped."
    ;;
  2)
    hadoop::stop
    echo "[+] Hadoop services stopped."
    ;;
  3)
    hive::stop
    echo "[+] Hive services stopped."
    ;;
  4)
    kafka::stop
    echo "[+] Kafka services stopped."
    ;;
  5)
    services::stop_airflow
    echo "[+] Airflow services stopped."
    ;;
  6)
    kafka::stop || true
    hive::stop || true
    hadoop::stop || true
    spark::stop || true
    echo "[+] Spark/Hadoop/Hive/Kafka services stopped."
    ;;
  7)
    (
      cd "${APP_REPO_ROOT}"
      docker compose stop "${SERVICE_NAME}"
    )
    ;;
  0)
    echo "Bye."
    ;;
  *)
    echo "Invalid option."
    exit 1
    ;;
esac
